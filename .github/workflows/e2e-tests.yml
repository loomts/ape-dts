name: E2E Tests

on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: "Test suite to run (optional, runs all if not specified)"
        required: false
        type: string
        default: ""
  schedule:
    - cron: '0 0 * * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  COMPOSE_FILE: ./dt-tests/tests/docker-compose.yml

jobs:
  list-test-suites:
    name: Discover E2E Test Suites
    runs-on: ubuntu-latest
    outputs:
      suites: ${{ steps.set-matrix.outputs.suites }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Generate Test Suite Matrix
        id: set-matrix
        working-directory: ./dt-tests/tests
        run: |
          SUITES=$(ls -d */ | grep -v 'test_runner/' | sed 's/\///' | jq -R . | jq -s .)
          echo "Discovered suites: $SUITES"
          echo "suites=$SUITES" >> $GITHUB_OUTPUT

  run-e2e-tests:
    name: E2E - ${{ matrix.test-suite }}
    needs: list-test-suites
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        test-suite: ${{ fromJson(needs.list-test-suites.outputs.suites) }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Rust Toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Cache Rust Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: integration-${{ matrix.test-suite }}-${{ runner.os }}

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Start Services & Setup Environment
        run: |
          if [[ -n "${{ github.event.inputs.test_suite }}" && "${{ github.event.inputs.test_suite }}" != "${{ matrix.test-suite }}" ]]; then
            echo "Skipping suite '${{ matrix.test-suite }}' as '${{ github.event.inputs.test_suite }}' was requested."
            exit 0
          fi

          echo "ğŸš€ Starting services for ${{ matrix.test-suite }}..."
          docker compose -f $COMPOSE_FILE down --volumes --remove-orphans || true

          echo "ğŸ” Starting services with health checks..."
          docker compose -f $COMPOSE_FILE up --detach --wait --timeout 600

          echo "âœ… All services are healthy and running."
          docker compose -f $COMPOSE_FILE ps

          echo "ğŸ“ Test environment is ready"

      - name: Run E2E Tests
        if: |
          (github.event.inputs.test_suite == '' || github.event.inputs.test_suite == matrix.test-suite)
        run: |
          echo "ğŸ§ª Running ${{ matrix.test-suite }} E2E tests..."
          cargo nextest run \
            --package dt-tests \
            --test integration_test \
            --no-fail-fast \
            '${{ matrix.test-suite }}::' \
            -- --test-threads=1 --test-timeout 300s

      - name: Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results-${{ matrix.test-suite }}
          path: |
            target/nextest/
          retention-days: 7

      - name: Cleanup Services
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up docker resources for ${{ matrix.test-suite }}..."
          if [[ ${{ job.status }} == 'failure' ]]; then
            echo "ğŸš¨ Job failed. Dumping service logs:"
            docker compose -f $COMPOSE_FILE logs --tail 200 || true
          fi
          docker compose -f $COMPOSE_FILE down --volumes --remove-orphans || true
